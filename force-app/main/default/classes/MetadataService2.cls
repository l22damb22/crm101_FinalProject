public class MetadataService2 {
    // âœ… Salesforce Connected Appì˜ Consumer Key & Secret ì„¤ì •
    private static final String CLIENT_ID = '3MVG91oqviqJKoEHvQjXeV7UqT.7MtliXXg2mVddHiKS3ClYEyoXmyx9WIGsOPOPz3cx5m9oi10nL5lI5aKtA';
    private static final String CLIENT_SECRET = '59DEFCB698575ED81011BE0625863161901D0F85735ED855CD4E00EBBA95F1A8';
    private static final String USERNAME = 'crm101prj@gmail.com';
    private static final String PASSWORD = 'crm101prjOjtKJ6cLCsK7uHzC9ZD4DAofA';
    private static final String TOKEN_URL = 'https://login.salesforce.com/services/oauth2/token';

    // âœ… OAuth 2.0ì„ ì‚¬ìš©í•˜ì—¬ Access Token ê°€ì ¸ì˜¤ê¸°
    public static Map<String, String> getAccessToken() {
        try {
            Http http = new Http();
            HttpRequest request = new HttpRequest();
            request.setEndpoint(TOKEN_URL);
            request.setMethod('POST');
            request.setHeader('Content-Type', 'application/x-www-form-urlencoded');

            String body = 'grant_type=password'
                + '&client_id=' + CLIENT_ID
                + '&client_secret=' + CLIENT_SECRET
                + '&username=' + USERNAME
                + '&password=' + PASSWORD;

            request.setBody(body);
            HttpResponse response = http.send(request);

            if (response.getStatusCode() == 200) {
                Map<String, Object> authResponse = (Map<String, Object>) JSON.deserializeUntyped(response.getBody());
                
                Map<String, String> result = new Map<String, String>();
                result.put('access_token', (String) authResponse.get('access_token'));
                result.put('instance_url', (String) authResponse.get('instance_url'));

                System.debug('âœ… OAuth ì¸ì¦ ì„±ê³µ: ' + JSON.serialize(result));
                return result;
            } else {
                System.debug('âŒ OAuth ì¸ì¦ ì‹¤íŒ¨: ' + response.getBody());
                return null;
            }
        } catch (Exception e) {
            System.debug('âŒ OAuth í† í° ìš”ì²­ ì‹¤íŒ¨: ' + e.getMessage());
            return null;
        }
    }

    // âœ… Metadata APIì™€ ì—°ê²°í•˜ëŠ” MetadataPort í´ë˜ìŠ¤
    public class MetadataPort {
        public String endpoint_x;
        public SessionHeader sessionHeader;

        public MetadataPort(String instance_url, String access_token) {
            this.endpoint_x = instance_url + '/services/Soap/m/59.0';  // âœ… instance_url ì‚¬ìš©
            this.sessionHeader = new MetadataService2.SessionHeader();
            this.sessionHeader.sessionId = access_token; // âœ… OAuth Access Token ì‚¬ìš©
            System.debug('âœ… Metadata API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •ë¨: ' + this.endpoint_x);
        }

        public MetadataService2.GlobalValueSet readMetadata(String globalValueSetName) {
            try {
                Http http = new Http();
                HttpRequest request = new HttpRequest();
                request.setEndpoint(this.endpoint_x);
                request.setMethod('POST');
                request.setHeader('Content-Type', 'text/xml');
                request.setHeader('SOAPAction', '""');
        
                // âœ… SOAP ìš”ì²­ ë³¸ë¬¸
                String requestBody = '<?xml version="1.0" encoding="UTF-8"?>'
                    + '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">'
                    + '<soapenv:Header>'
                    + '<SessionHeader xmlns="http://soap.sforce.com/2006/04/metadata">'
                    + '<sessionId>' + this.sessionHeader.sessionId + '</sessionId>'
                    + '</SessionHeader>'
                    + '</soapenv:Header>'
                    + '<soapenv:Body>'
                    + '<readMetadata xmlns="http://soap.sforce.com/2006/04/metadata">'
                    + '<type>GlobalValueSet</type>'
                    + '<fullNames>' + globalValueSetName + '</fullNames>'
                    + '</readMetadata>'
                    + '</soapenv:Body>'
                    + '</soapenv:Envelope>';
        
                request.setBody(requestBody);
                HttpResponse response = http.send(request);
        
                System.debug('ğŸ“¦ Metadata API ì‘ë‹µ (readMetadata): ' + response.getBody());
        
                if (response.getStatusCode() == 200) {
                    String responseBody = response.getBody();
                    
                    if (responseBody.contains('<fullName>')) {
                        String fullName = responseBody.substringBetween('<fullName>', '</fullName>');
                        System.debug('âœ… GlobalValueSet fullName: ' + fullName);
        
                        MetadataService2.GlobalValueSet gvs = new MetadataService2.GlobalValueSet();
                        gvs.fullName = fullName;
                        gvs.customValues = new List<MetadataService2.CustomValue>();
        
                        // âœ… ê¸°ì¡´ Picklist ê°’ ì¶”ì¶œ (Deactivated ë°©ì§€)
                        while (responseBody.contains('<customValue>')) {
                            String customValueXml = responseBody.substringBetween('<customValue>', '</customValue>');
                            
                            System.debug(customValueXml);

                            String valueName = customValueXml.substringBetween('<fullName>', '</fullName>');
                            String label = customValueXml.substringBetween('<label>', '</label>');
                            
                            //String strActive = customValueXml.substringBetween('<isActive>','</isActive>');
                            //Boolean isActive = (strActive.equals('true')) ? true : false; 
                            Boolean isActive = false;    
                            MetadataService2.CustomValue cv = new MetadataService2.CustomValue();
                            cv.fullName = valueName;
                            cv.label = label;
                            cv.isDefault = false;  // âœ… ê¸°ë³¸ì ìœ¼ë¡œ ê¸°ì¡´ ìƒíƒœ ìœ ì§€
                            cv.isActive = isActive;  // âœ… ê¸°ì¡´ ìƒíƒœ ë°˜ì˜
                            if (!isActive) {
                                System.debug('âŒ Deactivated ìƒíƒœ ìœ ì§€: ' + valueName);
                            }
        
                            gvs.customValues.add(cv);
                            
                            responseBody = responseBody.replaceFirst('<customValue>', '');
                        }
        
                        return gvs;
                    } else {
                        System.debug('âŒ GlobalValueSetì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return null;
                    }
                } else {
                    System.debug('âŒ readMetadata í˜¸ì¶œ ì‹¤íŒ¨, ì‘ë‹µ ì½”ë“œ: ' + response.getStatusCode());
                    return null;
                }
            } catch (Exception e) {
                System.debug('âŒ readMetadata í˜¸ì¶œ ì˜¤ë¥˜: ' + e.getMessage());
                return null;
            }
        }
        

        public Boolean upsertMetadata(MetadataService2.GlobalValueSet gvs) {
            try {
                Http http = new Http();
                HttpRequest request = new HttpRequest();
                request.setEndpoint(this.endpoint_x);
                request.setMethod('POST');
                request.setHeader('Content-Type', 'text/xml');
                request.setHeader('SOAPAction', '""');
        
                // âœ… SOAP XML ìš”ì²­ ìƒì„± (xsi ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì¶”ê°€)
                String requestBody = '<?xml version="1.0" encoding="UTF-8"?>'
                    + '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" '
                    + 'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">'
                    + '<soapenv:Header>'
                    + '<SessionHeader xmlns="http://soap.sforce.com/2006/04/metadata">'
                    + '<sessionId>' + this.sessionHeader.sessionId + '</sessionId>'
                    + '</SessionHeader>'
                    + '</soapenv:Header>'
                    + '<soapenv:Body>'
                    + '<upsertMetadata xmlns="http://soap.sforce.com/2006/04/metadata">'
                    + '<metadata xsi:type="GlobalValueSet">'
                    + '<fullName>' + gvs.fullName + '</fullName>'
                    + '<masterLabel>' + gvs.masterLabel + '</masterLabel>'
                    + '<sorted>' + gvs.sorted + '</sorted>';
        
                for (MetadataService2.CustomValue cv : gvs.customValues) {
                    // âœ… `isDefault` ê°’ì´ `null`ì´ë©´ `false`ë¡œ ì„¤ì •                   
                    requestBody += '<customValue>'
                        + '<fullName>' + cv.fullName + '</fullName>'
                        + '<label>' + cv.label + '</label>'
                        + '<default>' + cv.isDefault + '</default>'  // âœ… í™•ì‹¤í•œ boolean ê°’ ì ìš©
                        + '</customValue>';
                }
        
                requestBody += '</metadata>'
                    + '</upsertMetadata>'
                    + '</soapenv:Body>'
                    + '</soapenv:Envelope>';
        
                request.setBody(requestBody);
                HttpResponse response = http.send(request);
        
                System.debug('ğŸ“¦ Metadata API ì‘ë‹µ (upsertMetadata): ' + response.getBody());
        
                return response.getStatusCode() == 200;
            } catch (Exception e) {
                System.debug('âŒ upsertMetadata í˜¸ì¶œ ì˜¤ë¥˜: ' + e.getMessage());
                return false;
            }
        }
        
    }

    public abstract class Metadata {
        public String fullName;
    }

    public class GlobalValueSet extends Metadata {
        public String masterLabel = 'Brand Name List';
        public Boolean sorted = false;
        public CustomValue[] customValues;
    }

    public class CustomValue {
        public String fullName;
        public String label;
        public Boolean isDefault;  // âœ… ê¸°ë³¸ê°’ì„ falseë¡œ ì„¤ì •
        public Boolean isActive;
    }
    

    public class SessionHeader {
        public String sessionId;
    }
}
